<html>
<head>
  <meta charset="UTF-8">
  <title>Documentação</title>
  <style>/*! normalize.css v3.0.2 | MIT License | git.io/normalize */
/**
 * 1. Set default font family to sans-serif.
 * 2. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */
html {
  font-family: sans-serif; /* 1 */
  -ms-text-size-adjust: 100%; /* 2 */
  -webkit-text-size-adjust: 100%; /* 2 */
}
/**
 * Remove default margin.
 */
body {
  margin: 0;
}
/* HTML5 display definitions
   ========================================================================== */
/**
 * Correct `block` display not defined for any HTML5 element in IE 8/9.
 * Correct `block` display not defined for `details` or `summary` in IE 10/11
 * and Firefox.
 * Correct `block` display not defined for `main` in IE 11.
 */
article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
menu,
nav,
section,
summary {
  display: block;
}
/**
 * 1. Correct `inline-block` display not defined in IE 8/9.
 * 2. Normalize vertical alignment of `progress` in Chrome, Firefox, and Opera.
 */
audio,
canvas,
progress,
video {
  display: inline-block; /* 1 */
  vertical-align: baseline; /* 2 */
}
/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */
audio:not([controls]) {
  display: none;
  height: 0;
}
/**
 * Address `[hidden]` styling not present in IE 8/9/10.
 * Hide the `template` element in IE 8/9/11, Safari, and Firefox < 22.
 */
[hidden],
template {
  display: none;
}
/* Links
   ========================================================================== */
/**
 * Remove the gray background color from active links in IE 10.
 */
a {
  background-color: transparent;
}
/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */
a:active,
a:hover {
  outline: 0;
}
/* Text-level semantics
   ========================================================================== */
/**
 * Address styling not present in IE 8/9/10/11, Safari, and Chrome.
 */
abbr[title] {
  border-bottom: 1px dotted;
}
/**
 * Address style set to `bolder` in Firefox 4+, Safari, and Chrome.
 */
b,
strong {
  font-weight: bold;
}
/**
 * Address styling not present in Safari and Chrome.
 */
dfn {
  font-style: italic;
}
/**
 * Address variable `h1` font-size and margin within `section` and `article`
 * contexts in Firefox 4+, Safari, and Chrome.
 */
h1 {
  font-size: 2em;
  margin: 0.67em 0;
}
/**
 * Address styling not present in IE 8/9.
 */
mark {
  background: #ff0;
  color: #000;
}
/**
 * Address inconsistent and variable font size in all browsers.
 */
small {
  font-size: 80%;
}
/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */
sub,
sup {
  font-size: 75%;
  line-height: 0;
  position: relative;
  vertical-align: baseline;
}
sup {
  top: -0.5em;
}
sub {
  bottom: -0.25em;
}
/* Embedded content
   ========================================================================== */
/**
 * Remove border when inside `a` element in IE 8/9/10.
 */
img {
  border: 0;
}
/**
 * Correct overflow not hidden in IE 9/10/11.
 */
svg:not(:root) {
  overflow: hidden;
}
/* Grouping content
   ========================================================================== */
/**
 * Address margin not present in IE 8/9 and Safari.
 */
figure {
  margin: 1em 40px;
}
/**
 * Address differences between Firefox and other browsers.
 */
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  height: 0;
}
/**
 * Contain overflow in all browsers.
 */
pre {
  overflow: auto;
}
/**
 * Address odd `em`-unit font size rendering in all browsers.
 */
code,
kbd,
pre,
samp {
  font-family: monospace, monospace;
  font-size: 1em;
}
/* Forms
   ========================================================================== */
/**
 * Known limitation: by default, Chrome and Safari on OS X allow very limited
 * styling of `select`, unless a `border` property is set.
 */
/**
 * 1. Correct color not being inherited.
 *    Known issue: affects color of disabled elements.
 * 2. Correct font properties not being inherited.
 * 3. Address margins set differently in Firefox 4+, Safari, and Chrome.
 */
button,
input,
optgroup,
select,
textarea {
  color: inherit; /* 1 */
  font: inherit; /* 2 */
  margin: 0; /* 3 */
}
/**
 * Address `overflow` set to `hidden` in IE 8/9/10/11.
 */
button {
  overflow: visible;
}
/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Firefox, IE 8/9/10/11, and Opera.
 * Correct `select` style inheritance in Firefox.
 */
button,
select {
  text-transform: none;
}
/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 */
button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
  -webkit-appearance: button; /* 2 */
  cursor: pointer; /* 3 */
}
/**
 * Re-set default cursor for disabled elements.
 */
button[disabled],
html input[disabled] {
  cursor: default;
}
/**
 * Remove inner padding and border in Firefox 4+.
 */
button::-moz-focus-inner,
input::-moz-focus-inner {
  border: 0;
  padding: 0;
}
/**
 * Address Firefox 4+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */
input {
  line-height: normal;
}
/**
 * It's recommended that you don't attempt to style these elements.
 * Firefox's implementation doesn't respect box-sizing, padding, or width.
 *
 * 1. Address box sizing set to `content-box` in IE 8/9/10.
 * 2. Remove excess padding in IE 8/9/10.
 */
input[type="checkbox"],
input[type="radio"] {
  box-sizing: border-box; /* 1 */
  padding: 0; /* 2 */
}
/**
 * Fix the cursor style for Chrome's increment/decrement buttons. For certain
 * `font-size` values of the `input`, it causes the cursor style of the
 * decrement button to change from `default` to `text`.
 */
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button {
  height: auto;
}
/**
 * 1. Address `appearance` set to `searchfield` in Safari and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari and Chrome
 *    (include `-moz` to future-proof).
 */
input[type="search"] {
  -webkit-appearance: textfield; /* 1 */
  -moz-box-sizing: content-box;
  -webkit-box-sizing: content-box; /* 2 */
  box-sizing: content-box;
}
/**
 * Remove inner padding and search cancel button in Safari and Chrome on OS X.
 * Safari (but not Chrome) clips the cancel button when the search input has
 * padding (and `textfield` appearance).
 */
input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
  -webkit-appearance: none;
}
/**
 * Define consistent border, margin, and padding.
 */
fieldset {
  border: 1px solid #c0c0c0;
  margin: 0 2px;
  padding: 0.35em 0.625em 0.75em;
}
/**
 * 1. Correct `color` not being inherited in IE 8/9/10/11.
 * 2. Remove padding so people aren't caught out if they zero out fieldsets.
 */
legend {
  border: 0; /* 1 */
  padding: 0; /* 2 */
}
/**
 * Remove default vertical scrollbar in IE 8/9/10/11.
 */
textarea {
  overflow: auto;
}
/**
 * Don't inherit the `font-weight` (applied by a rule above).
 * NOTE: the default cannot safely be changed in Chrome and Safari on OS X.
 */
optgroup {
  font-weight: bold;
}
/* Tables
   ========================================================================== */
/**
 * Remove most spacing between table cells.
 */
table {
  border-collapse: collapse;
  border-spacing: 0;
}
td,
th {
  padding: 0;
}
table {
    display: block;
    width: 100%;
    overflow: auto;
    word-break: normal;
    word-break: keep-all
}
table th {
    font-weight: bold
}
table th, table td {
    padding: 6px 13px;
    border: 1px solid #ddd
}
table tr {
    background-color: #fff;
    border-top: 1px solid #ccc
}
table tr:nth-child(2n) {
    background-color: #f8f8f8
}
html {
  overflow-y: scroll;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}
body {
  overflow: hidden;
  font-family: "Helvetica Neue", Helvetica, "Segoe UI", Arial, freesans, sans-serif;
  font-size: 16px;
  line-height: 1.6;
  word-wrap: break-word;
  margin: auto;
  max-width: 918px;
  color: #333;
  background: #fff;
}
a {
  color: #4183c4;
  text-decoration: none;
}
a:hover, a:active {
  outline: 0;
  text-decoration: underline;
}
a:focus {
  outline: thin dotted;
}
::-moz-selection {
  background: rgba(255,255,0,0.3);
  color: #000;
}
::selection {
  background: rgba(255,255,0,0.3);
  color: #000;
}
a::-moz-selection {
  background: rgba(255,255,0,0.3);
  color: #0645ad;
}
a::selection {
  background: rgba(255,255,0,0.3);
  color: #0645ad;
}
p {
  margin: 1em 0;
}
img {
  max-width: 100%;
}
h1, h2, h3, h4, h5, h6 {
  position: relative;
  margin-top: 1em;
  margin-bottom: 16px;
  font-weight: bold;
  line-height: 1.4;
}
h1 {
  padding-bottom: 0.3em;
  font-size: 2.25em;
  line-height: 1.2;
  border-bottom: 1px solid #eee;
}
h2 {
  padding-bottom: 0.3em;
  font-size: 1.75em;
  line-height: 1.225;
  border-bottom: 1px solid #eee;
}
h3 {
  font-size: 1.5em;
  line-height: 1.43;
}
h4 {
  font-size: 1.25em;
}
h5 {
  font-size: 1em;
}
h6 {
  font-size: 1em;
  color: #777;
}
p, blockquote, ul, ol, dl, table, pre {
  margin-top: 0;
  margin-bottom: 16px;
}
blockquote {
  padding: 0 15px;
  color: #777;
  border-left: 4px solid #ddd;
}
hr {
  height: 4px;
  padding: 0;
  margin: 16px 0;
  background-color: #e7e7e7;
  border: 0 none;
}
pre,
code,
kbd,
samp {
  color: #000;
  font-family: Consolas, "Source Code Pro", monospace;
  font-size: .90em;
}
code {
  display: inline-block;
  padding: 1px;
  line-height: 1.3;
  border-radius: 3px;
  max-width: 100%;
.hljs-subst,
.hljs-request,
.hljs-status {
  color: #333;
  font-weight: bold;
}
.hljs-number,
.hljs-hexcolor,
.ruby .hljs-constant {
  color: #099;
}
.hljs-string,
.hljs-tag .hljs-value,
.hljs-phpdoc,
.tex .hljs-formula {
  color: #d14;
}
.hljs-title,
.hljs-id,
.coffeescript .hljs-params,
.scss .hljs-preprocessor {
  color: #900;
  font-weight: bold;
}
.javascript .hljs-title,
.lisp .hljs-title,
.clojure .hljs-title,
.hljs-subst {
  font-weight: normal;
}
.hljs-class .hljs-title,
.haskell .hljs-type,
.vhdl .hljs-literal,
.tex .hljs-command {
  color: #458;
  font-weight: bold;
}
.hljs-tag,
.hljs-tag .hljs-title,
.hljs-rules .hljs-property,
.django .hljs-tag .hljs-keyword {
  color: #000080;
  font-weight: normal;
}
.hljs-attribute,
.hljs-variable,
.lisp .hljs-body {
  color: #008080;
}
.hljs-regexp {
  color: #009926;
}
.hljs-symbol,
.ruby .hljs-symbol .hljs-string,
.lisp .hljs-keyword,
.tex .hljs-special,
.hljs-prompt {
  color: #990073;
}
.hljs-built_in,
.lisp .hljs-title,
.clojure .hljs-built_in {
  color: #0086b3;
}
.hljs-preprocessor,
.hljs-pragma,
.hljs-pi,
.hljs-doctype,
.hljs-shebang,
.hljs-cdata {
  color: #999;
  font-weight: bold;
}
.hljs-deletion {
  background: #fdd;
}
.hljs-addition {
  background: #dfd;
}
.diff .hljs-change {
  background: #0086b3;
}
.hljs-chunk {
  color: #aaa;
}
    </style>
</head>
<body><h1 id="web-buscapé-implementação-de-gtm-e-camada-de-dados"><strong>Web: Buscapé - Implementação de GTM e Camada de Dados</strong></h1>

<p>Manual de implementação da Camada de Dados para o ambiente Buscapé.</p>

<h2 id="geral"><strong>Geral</strong></h2>

<p>Esse documento deve ser utilizado como guia para a criação da Camada de Dados.</p>

<h2 id="escopo"><strong>Escopo</strong></h2>

<p>Serão consideradas todas as páginas do ambiente de Buscapé Desktop.</p>



<h2 id="camada-de-dados"><strong>Camada de Dados</strong></h2>



<h3 id="geral-1"><strong>Geral</strong></h3>

<p>Utilizamos um objeto JavaScript (notação JSON) com as informações sobre a página, como por exemplo: informações de usuários, informações de anúncios, etc. Ele deve ser inserido antes da chamada do GTM (Google Tag Manager) presente na página. Abaixo estão algumas características da Camada de Dados:</p>

<ul>
<li>Contém informações sobre o portal, páginas e produtos relacionados a seção.</li>
<li>Por ser escrito em JavaScript, poderá ser utilizado por outros scripts da página.</li>
<li>Deve ser inserido em todas as páginas.</li>
<li>A estrutura do objeto pode evoluir no decorrer do projeto.</li>
</ul>



<h3 id="funcionamento-e-fluxos-de-cpc-cpa-e-buscapé-checkout"><strong>Funcionamento e fluxos de CPC, CPA e Buscapé Checkout</strong></h3>

<p>Em <strong>CPC</strong> ocorre um disparo com evento e transação juntos, ou seja, dispara um evento quando clicado em “Ir à Loja”, feito pelo redirecionamento, juntamente com a coleta de transação. Essas informações serão mandadas via disparo serverside.</p>

<p>Em <strong>CPA</strong> ocorrem no mínimo dois disparos, em momentos diferentes. O primeiro dispara um evento quando clicado em “Ir à Loja”, feito pelo redirecionamento, e o segundo disparo, que coleta a transação, só ocorre quando houver uma venda de fato no site do Lojista para o qual o usuário foi redirecionado. Ambos disparos deverão conter informações mandadas via disparo serverside. Há um período de latência considerado após o redirecionamento, podendo haver mais de um disparo de transação.</p>

<p>Em <strong>Buscapé Checkout</strong> ocorrem dois disparos, em momentos diferentes. O primeiro quando o fluxo de compra for concluído (via datalayer - apenas com o valor de exibição do produto) e o segundo quando o Buscapé confirmar o faturamento da transação (via serverside - com o valor de exibição do produto e a comissão recebida pelo Buscapé).</p>



<h2 id="funcionamento-da-variável-datalayer"><strong>Funcionamento da variável dataLayer</strong></h2>

<p>A variável da camada de dados instalada tem o nome de <strong>dataLayer</strong>, ela é um Objeto javascript.</p>

<p>Internamente, o Google Tag Manager faz a junção destes múltiplos objetos inseridos na camada de dados. No momento do disparo da tag, o valor utilizado para cada chave é o último valor inserido naquela chave.</p>



<h2 id="tipos-dos-dados-utilizados"><strong>Tipos dos dados utilizados</strong></h2>

<table>
<thead>
<tr>
  <th>Nome</th>
  <th align="left">Descrição</th>
  <th align="left">exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>String</td>
  <td align="left">Um texto, entre aspas</td>
  <td align="left">“um texto”</td>
</tr>
<tr>
  <td>Number</td>
  <td align="left">Um número, não utilizar texto no lugar, principalmente com separadores de milhar</td>
  <td align="left">15.71</td>
</tr>
<tr>
  <td>Bool</td>
  <td align="left">true ou false</td>
  <td align="left">true</td>
</tr>
<tr>
  <td>Array</td>
  <td align="left">Uma lista de elementos</td>
  <td align="left">[1, 2, 3]</td>
</tr>
<tr>
  <td>Object</td>
  <td align="left">Um dado com subníveis</td>
  <td align="left">{“nivel1”: {“nivel2_item1”: “valor1”, “nivel2_item2”: “valor2”}}</td>
</tr>
</tbody></table>




<h2 id="implementação-básica"><strong>Implementação básica</strong></h2>



<h3 id="configurações-gerais"><strong>Configurações Gerais</strong></h3>

<ul>
<li>Container Web: GTM-W7LVSD</li>
</ul>



<h3 id="exemplo"><strong>Exemplo</strong></h3>



<pre class="prettyprint"><code class="language-html hljs "><span class="hljs-tag">&lt;<span class="hljs-title">DOCTYPE</span> <span class="hljs-attribute">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-title">html</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">link</span> <span class="hljs-attribute">rel</span>=<span class="hljs-value">"stylesheet"</span> <span class="hljs-attribute">type</span>=<span class="hljs-value">"text/css"</span> <span class="hljs-attribute">href</span>=<span class="hljs-value">"main/css.css"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">meta</span> <span class="hljs-attribute">http-equiv</span>=<span class="hljs-value">"content-type"</span> <span class="hljs-attribute">content</span>=<span class="hljs-value">"text/html;charset=utf-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">title</span>&gt;</span>Exemple<span class="hljs-tag">&lt;/<span class="hljs-title">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">
      window.dataLayer = window.dataLayer || [];
      dataLayer.push({
        usuario: {
          id: <span class="hljs-string">"123-456-789"</span>,
          tipo_login: <span class="hljs-string">"facebook"</span>
        },
        pagina: {
          template: <span class="hljs-string">"busca"</span>,
          termo_busca: <span class="hljs-string">"refrigerador consul"</span>,
          quantidade_resultados: <span class="hljs-number">84</span>
        },
        listas: [{
          nome: <span class="hljs-string">"Você pode Gostar"</span>,
          items: [{
            nome: <span class="hljs-string">"Smartphone LG K10 K430TV"</span>,
            sku: <span class="hljs-string">"212984103"</span>,
            preco: <span class="hljs-number">643.50</span>,
            marca: <span class="hljs-string">"LG"</span>,
            lojista: <span class="hljs-string">"Casas Bahia"</span>,
            categoria_principal: <span class="hljs-string">"telefonia"</span>,
            subcategorias: [<span class="hljs-string">"celular e smartphone"</span>]
          }]
        }]
      });
    </span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-title">body</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Google Tag Manager --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">noscript</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-title">iframe</span> <span class="hljs-attribute">src</span>=<span class="hljs-value">"//www.googletagmanager.com/ns.html?id=GTM-W7LVSD"</span>
    <span class="hljs-attribute">height</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">width</span>=<span class="hljs-value">"0"</span> <span class="hljs-attribute">style</span>=<span class="hljs-value">"display:none;visibility:hidden"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">iframe</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">noscript</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">script</span>&gt;</span><span class="javascript">(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(w,d,s,l,i)</span>{</span>w[l]=w[l]||[];w[l].push({<span class="hljs-string">'gtm.start'</span>:
    <span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>().getTime(),event:<span class="hljs-string">'gtm.js'</span>});<span class="hljs-keyword">var</span> f=d.getElementsByTagName(s)[<span class="hljs-number">0</span>],
    j=d.createElement(s),dl=l!=<span class="hljs-string">'dataLayer'</span>?<span class="hljs-string">'&amp;l='</span>+l:<span class="hljs-string">''</span>;j.async=<span class="hljs-literal">true</span>;j.src=
    <span class="hljs-string">'//www.googletagmanager.com/gtm.js?id='</span>+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,<span class="hljs-string">'script'</span>,<span class="hljs-string">'dataLayer'</span>,<span class="hljs-string">'GTM-W7LVSD'</span>);</span><span class="hljs-tag">&lt;/<span class="hljs-title">script</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- End Google Tag Manager --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"container"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"body"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-title">div</span> <span class="hljs-attribute">class</span>=<span class="hljs-value">"footer"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-title">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-title">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-title">html</span>&gt;</span>
</code></pre>



<h2 id="chaves-da-camada-de-dados"><strong>Chaves da Camada de Dados</strong></h2>

<p>As chaves abaixo devem ser adicionadas ao objeto dataLayer em qualquer página em que o dado esteja disponível. O preenchimento do dataLayer deve ocorrer logo no início do carregamento da página.</p>



<h3 id="usuário"><strong>Usuário</strong></h3>

<p>Contém informações sobre o usuário que está utilizando o site. Deve estar presente em todas as páginas enquanto o usuário estiver logado.</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>id</td>
  <td>String</td>
  <td>Identificador do usuário logado</td>
  <td>“123234345”</td>
</tr>
<tr>
  <td>tipo_login</td>
  <td>String</td>
  <td>Método de autenticação utilizada pelo usuário</td>
  <td>“email”</td>
</tr>
</tbody></table>




<h2 id="valores-de-preenchimento-para-usuariotipologin"><strong>Valores de preenchimento para usuario.tipo_login</strong></h2>

<table>
<thead>
<tr>
  <th>Regras</th>
  <th>Valor esperado</th>
</tr>
</thead>
<tbody><tr>
  <td>Não</td>
  <td>logado “nao_logado”</td>
</tr>
<tr>
  <td>Logado</td>
  <td>com email   “email”</td>
</tr>
<tr>
  <td>Logado</td>
  <td>com Facebook    “facebook”</td>
</tr>
</tbody></table>


<p><strong>Observação: Os valores devem ser todos minúsculos, sem acentos e sem espaços</strong></p>

<pre class="prettyprint"><code class="language-js hljs ">
dataLayer.push({
  pagina: {
    template: <span class="hljs-string">"home"</span>
  },
  usuario: {
    id: <span class="hljs-string">"123234345"</span>,
    tipo_login: <span class="hljs-string">"email"</span>
  }
});</code></pre>

<h3 id="página"><strong>Página</strong></h3>

<p>Contém informações sobre a página que está sendo exibida. Possui informações gerais e específicas para alguns tipos de templates.</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>template</td>
  <td>String</td>
  <td>Template da página acessada</td>
  <td>“pu”</td>
</tr>
<tr>
  <td>termo_busca</td>
  <td>String</td>
  <td>Termo buscado pelo usuário. Deve ser preenchido apenas nos momentos em que o usuário realizou uma pesquisa através da barra de busca.</td>
  <td>“bicicleta”</td>
</tr>
<tr>
  <td>quantidade_resultados</td>
  <td>Number</td>
  <td>Quantidade de ofertas resultantes da pesquisa</td>
  <td>84</td>
</tr>
<tr>
  <td>categoria_principal</td>
  <td>String</td>
  <td>Primeiro nível de categoria da página atual, seja ela navegação ou produto único</td>
  <td>“Esporte e Lazer</td>
</tr>
<tr>
  <td>subcategorias</td>
  <td>Array de Strings</td>
  <td>Demais níveis de categoria da página atual</td>
  <td>[“Ciclismo”, “Bicicleta”]</td>
</tr>
</tbody></table>


<h3 id="valores-de-preenchimento-para-paginatemplate"><strong>Valores de preenchimento para pagina.template</strong></h3>

<table>
<thead>
<tr>
  <th>Ambiente / local</th>
  <th>Valor esperado</th>
</tr>
</thead>
<tbody><tr>
  <td>Página inicial</td>
  <td>“home”</td>
</tr>
<tr>
  <td>Categoria Mãe</td>
  <td>“categoria”</td>
</tr>
<tr>
  <td>Categoria Final</td>
  <td>“categoria”</td>
</tr>
<tr>
  <td>Produto (PU)</td>
  <td>“pu”</td>
</tr>
<tr>
  <td>Comparação de Produtos</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Checkout</td>
  <td>“checkout”</td>
</tr>
<tr>
  <td>Oferta</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Usuário</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Busca</td>
  <td>“busca”</td>
</tr>
<tr>
  <td>Lojas</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Páginas Especiais</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Páginas Sazonais</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Guia de Compra</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Matérias</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Livros</td>
  <td>“?”</td>
</tr>
<tr>
  <td>Marcas</td>
  <td>“?”</td>
</tr>
</tbody></table>


<p><strong>Observação: Os valores devem ser todos minúsculos, sem acentos e sem espaços.</strong></p>

<h3 id="exemplo-pu"><strong>Exemplo P.U.</strong></h3>



<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  pagina: {
    template: <span class="hljs-string">"pu"</span>,
    categoria_principal: <span class="hljs-string">"Esporte e Lazer"</span>,
    subcategorias: [<span class="hljs-string">"Ciclismo"</span>, <span class="hljs-string">"Bicicleta"</span>]
  }
});
</code></pre>

<h3 id="exemplo-página-de-busca"><strong>Exemplo Página de Busca</strong></h3>



<pre class="prettyprint"><code class="language-js hljs ">
dataLayer.push({
  pagina: {
    template: <span class="hljs-string">"busca"</span>,
    termo_busca: <span class="hljs-string">"bicicleta"</span>,
    quantidade_resultados: <span class="hljs-number">84</span>
  }
});</code></pre>

<h3 id="produto-único-pu"><strong>Produto Único - P.U</strong></h3>

<p>Nas páginas de produto único, será necessário termos um objeto contendo todas as informações do produto sendo exibido e uma lista com os detalhes de cada oferta.</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th align="left">Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>nome</td>
  <td align="left">String</td>
  <td>Nome do produto</td>
  <td>“Caloi Star Wars Aro 24”</td>
</tr>
<tr>
  <td>marca</td>
  <td align="left">String</td>
  <td>Marca do fabricante do produto</td>
  <td>“Caloi”</td>
</tr>
<tr>
  <td>categoria_principal</td>
  <td align="left">String</td>
  <td>Categoria do produto</td>
  <td>“Esporte e Lazer”</td>
</tr>
<tr>
  <td>subcategorias</td>
  <td align="left">Array de String</td>
  <td>Demais subcategorias do produto</td>
  <td>[“Ciclismo”, “Bicicleta”]</td>
</tr>
<tr>
  <td>ofertas</td>
  <td align="left">Array de Objects</td>
  <td>Todas as ofertas disponíveis na página</td>
  <td>Ver produto_unico.ofertas</td>
</tr>
</tbody></table>


<h3 id="produtounicoofertas"><strong>produto_unico.ofertas</strong></h3>

<p>Deve ser uma lista com as informações de cada oferta do produto.</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>sku</td>
  <td>String</td>
  <td>SKU da oferta</td>
  <td>“628638”</td>
</tr>
<tr>
  <td>preco</td>
  <td>Number</td>
  <td>Preço de exibição do produto</td>
  <td>509.99</td>
</tr>
<tr>
  <td>lojista</td>
  <td>String</td>
  <td>Nome da loja da oferta</td>
  <td>Magazine Luiza</td>
</tr>
</tbody></table>




<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  pagina: {
    template: <span class="hljs-string">"pu"</span>,
    categoria_principal: <span class="hljs-string">"Esporte e Lazer"</span>,
    subcategorias: [<span class="hljs-string">"Ciclismo"</span>, <span class="hljs-string">"Bicicleta"</span>],
  },
  produto: {
    nome: <span class="hljs-string">"Caloi Star Wars Aro 24"</span>,
    marca: <span class="hljs-string">"Caloi"</span>,
    ofertas: [{
      sku: <span class="hljs-string">"628638"</span>,
      preco: <span class="hljs-number">509.99</span>
      lojista: <span class="hljs-string">"Magazine Luiza"</span>
    }]
  }
});</code></pre>

<h3 id="listas"><strong>listas</strong></h3>

<table>
<thead>
<tr>
  <th>Tipo</th>
  <th>Páginas</th>
</tr>
</thead>
<tbody><tr>
  <td>Array de Objects</td>
  <td>Qualquer página com listas de ofertas</td>
</tr>
</tbody></table>


<p>Todas as listas de produtos que aparecem na página devem ser identificadas com o nome da lista (ex: menor preço, você pode gostar, resultado de busca) e a lista de ofertas presentes na lista.</p>

<p>Cada um dos Objects do tipo Lista segue o formato:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>nome</td>
  <td>String</td>
  <td>Nome da lista de exibição</td>
  <td>“Menor Preço”</td>
</tr>
<tr>
  <td>items</td>
  <td>Array de Object</td>
  <td>Lista de ofertas na ordem apresentada</td>
  <td>ver Object Item</td>
</tr>
</tbody></table>


<h3 id="listasitems"><strong>listas.items</strong></h3>

<p>A chave itens é um Array de vários objetos do tipo Item, seguindo o seguinte formato:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th align="left">Tipo</th>
  <th align="left">Descrição</th>
  <th align="left">Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>nome</td>
  <td align="left">String</td>
  <td align="left">Nome do produto</td>
  <td align="left">“Caloi Star Wars Aro 24”</td>
</tr>
<tr>
  <td>sku</td>
  <td align="left">String</td>
  <td align="left">SKU da oferta exibida</td>
  <td align="left">“628638”</td>
</tr>
<tr>
  <td>preco</td>
  <td align="left">Number</td>
  <td align="left">Preço de exibição do produto</td>
  <td align="left">509.99</td>
</tr>
<tr>
  <td>marca</td>
  <td align="left">String</td>
  <td align="left">Marca do fabricante do produto</td>
  <td align="left">“Caloi”</td>
</tr>
<tr>
  <td>categoria_principal</td>
  <td align="left">String</td>
  <td align="left">Categoria do produto</td>
  <td align="left">“Esporte e Lazer”</td>
</tr>
<tr>
  <td>subcategorias</td>
  <td align="left">Array de String</td>
  <td align="left">Demais subcategorias do produto</td>
  <td align="left">[“Ciclismo”, “Bicicleta”]</td>
</tr>
<tr>
  <td>lojista</td>
  <td align="left">String</td>
  <td align="left">Nome da loja da oferta</td>
  <td align="left">Magazine Luiza</td>
</tr>
</tbody></table>


<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  pagina: {
    template: <span class="hljs-string">"home"</span>,
  },
  listas: [{
     nome: <span class="hljs-string">'Menor Preço'</span>,
     items: [{
       nome: <span class="hljs-string">"Caloi Star Wars Aro 24"</span>,
       sku: <span class="hljs-string">"628638"</span>,
       preco: <span class="hljs-number">509.99</span>,
       marca: <span class="hljs-string">"Caloi"</span>,
       categoria_principal: <span class="hljs-string">"Esporte e Lazer"</span>,
       subcategorias: [<span class="hljs-string">"Ciclismo"</span>, <span class="hljs-string">"Bicicleta"</span>],
       lojista:<span class="hljs-string">'magazine-luiza'</span>
     }]
  }]
});
</code></pre>

<h3 id="buscapé-checkout"><strong>Buscapé Checkout</strong></h3>

<p>Pelo fato de o Buscapé Checkout ser um one page checkout, ou seja, a página não é recarregada entre cada passo, precisaremos adicionar alguns eventos para indicar que o usuário alcançou um novo passo no processo.</p>

<p>Na abertura do checkout, deverá ser enviado um evento para a camada de dados contendo os dados do produto selecionado:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th align="left">Tipo</th>
  <th align="left">Descrição</th>
  <th align="left">Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>sku</td>
  <td align="left">String</td>
  <td align="left">SKU da oferta</td>
  <td align="left">“628638”</td>
</tr>
<tr>
  <td>nome</td>
  <td align="left">String</td>
  <td align="left">Nome do produto</td>
  <td align="left">“Caloi Star Wars Aro 24”</td>
</tr>
<tr>
  <td>marca</td>
  <td align="left">String</td>
  <td align="left">Marca do fabricante do produto</td>
  <td align="left">“Caloi”</td>
</tr>
<tr>
  <td>categoria_principal</td>
  <td align="left">String</td>
  <td align="left">Categoria do produto</td>
  <td align="left">“Esporte e Lazer”</td>
</tr>
<tr>
  <td>subcategorias</td>
  <td align="left">Array de String</td>
  <td align="left">Demais subcategorias do produto</td>
  <td align="left">[“Ciclismo”, “Bicicleta”]</td>
</tr>
<tr>
  <td>preco</td>
  <td align="left">Number</td>
  <td align="left">Preço de exibição do produto</td>
  <td align="left">509.99</td>
</tr>
<tr>
  <td>quantidade</td>
  <td align="left">Number</td>
  <td align="left">Quantidade do Produto</td>
  <td align="left">2</td>
</tr>
<tr>
  <td>loja</td>
  <td align="left">String</td>
  <td align="left">Nome da loja da oferta</td>
  <td align="left">Magazine Luiza</td>
</tr>
</tbody></table>


<h4 id="passo-1-autenticação"><strong>Passo 1 (Autenticação)</strong></h4>

<p>Neste momento deveria ser enviado para a camada de dados os produtos que estão sendo comprados e um identificador do passo.</p>

<p>É importante notar que a chave ofertas possui um Array, pois é possível ter mais de 1 produto no checkout. Mesmo que apenas 1 produto esteja sendo comprado, deve-se adicionar no dataLayer um Array.</p>



<pre class="prettyprint"><code class=" hljs profile"><span class="hljs-filename">dataLayer.push({
  pagina</span>: {<span class="hljs-built_in">
    template: <span class="hljs-string">"checkout"</span>
  },
  passo: <span class="hljs-string">'1 - Autenticação'</span>,
  ofertas: [{
    sku: <span class="hljs-string">"628638"</span>,
    nome: <span class="hljs-string">"Caloi Star Wars Aro 24"</span>,
    marca: <span class="hljs-string">"Caloi"</span>,
    categoria_principal: <span class="hljs-string">"Esporte e Lazer"</span>,
    subcategorias: [<span class="hljs-string">"Ciclismo"</span>, <span class="hljs-string">"Bicicleta"</span>],
    preco: 509.99,
    quantidade: 1,
    loja: <span class="hljs-string">"Magazine Luiza"</span>
  }, {
    sku: <span class="hljs-string">"194212566"</span>,
    nome: <span class="hljs-string">"JBL Flip 3 16W RMS"</span>,
    marca: <span class="hljs-string">"JBL"</span>,
    categoria_principal: <span class="hljs-string">"Informática"</span>,
    subcategorias: [<span class="hljs-string">"Periféricos"</span>, <span class="hljs-string">"Caixas de Som para PC"</span>],
    preco: 559.94,
    quantidade: 2,
    loja: <span class="hljs-string">"Fast Shop"</span>
  }]
});</span></code></pre>

<p>Se o usuário retornar a este passo depois de ter ido para um seguinte, o evento deverá ser enviado novamente contendo apenas o nome do passo:</p>

<pre class="prettyprint"><code class=" hljs css"><span class="hljs-tag">dataLayer</span><span class="hljs-class">.push</span>(<span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">event</span>:<span class="hljs-value"> <span class="hljs-string">'buscapeCheckout'</span>,
  passo: <span class="hljs-string">'1 - Autenticação'</span>
</span></span></span>});</code></pre>



<h4 id="passos-2-entrega-e-3-pagamento"><strong>Passos 2 (Entrega) e 3 (Pagamento)</strong></h4>

<p>Para os outros passos, deverá ser enviado apenas o evento contendo o nome do passo:</p>



<pre class="prettyprint"><code class=" hljs css"><span class="hljs-tag">dataLayer</span><span class="hljs-class">.push</span>(<span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">event</span>:<span class="hljs-value"> <span class="hljs-string">'buscapeCheckout'</span>,
  passo: <span class="hljs-string">'2 - Entrega'</span>
</span></span></span>});</code></pre>

<pre class="prettyprint"><code class=" hljs css"><span class="hljs-tag">dataLayer</span><span class="hljs-class">.push</span>(<span class="hljs-rules">{
  <span class="hljs-rule"><span class="hljs-attribute">event</span>:<span class="hljs-value"> <span class="hljs-string">'buscapeCheckout'</span>,
  passo: <span class="hljs-string">'3 - Pagamento'</span>
</span></span></span>});</code></pre>

<h3 id="mudança-na-quantidade"><strong>Mudança na quantidade</strong></h3>

<p>Caso o usuário mude a quantidade de um dos produtos, ou remova algum produto do carrinho, um evento do tipo mudar_quantidade deve ser adicionado ao dataLayer.</p>

<table>
<thead>
<tr>
  <th>Nome</th>
  <th align="left">Tipo de Dado</th>
  <th align="left">Descrição</th>
  <th align="left">Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>mudar_quantidade</td>
  <td align="left">Object</td>
  <td align="left">Objeto onde a chave é o SKU do produto alterado e o valor é a nova quantidade de produtos</td>
  <td align="left">{“123542”: 2}</td>
</tr>
</tbody></table>


<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  event: <span class="hljs-string">"mudar_quantidade"</span>,
  mudar_quantidade: {
    <span class="hljs-string">"628638"</span>: <span class="hljs-number">3</span>,
    <span class="hljs-string">"194212566"</span>: <span class="hljs-number">0</span>
  }
});</code></pre>

<p><strong>Remover um produto equivale a mudar a quantidade para zero.</strong></p>



<h3 id="conclusão-de-compra"><strong>Conclusão de compra</strong></h3>

<p>Para mantermos o sigilo das informações de negociação do Buscapé com as lojas, devemos enviar a conclusão de compra através do backend assim como em CPC/CPA (ver Coleta de Transações abaixo). Mesmo neste caso, ainda precisaremos de uma confirmação que a compra foi realizada para efeitos de tags de mídia, por exemplo.</p>



<h4 id="transacao"><strong>transacao</strong></h4>

<p>Sempre que uma compra for realizada com sucesso, deverá ser enviado um evento com as informações da transação:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>id</td>
  <td>String</td>
  <td>ID</td>
  <td>interno da transação</td>
</tr>
<tr>
  <td>parcelas</td>
  <td>Number</td>
  <td>Quantidade de parcelas escolhidas pelo usuário</td>
  <td>6</td>
</tr>
<tr>
  <td>frete</td>
  <td>Object</td>
  <td>Detalhes do frete escolhido pelo usuário</td>
  <td>ver transacao.frete</td>
</tr>
</tbody></table>




<h4 id="transacaofrete"><strong>transacao.frete</strong></h4>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>modalidade</td>
  <td>String</td>
  <td>Modalidade do frete escolhido</td>
  <td>E-Sedex</td>
</tr>
<tr>
  <td>valor</td>
  <td>Number Valor do frete</td>
  <td>12.0</td>
  <td></td>
</tr>
<tr>
  <td>dias</td>
  <td>Number</td>
  <td>Dias úteis para a entrega da compra</td>
  <td>14</td>
</tr>
</tbody></table>




<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  event: <span class="hljs-string">'buscapeCheckout'</span>,
  passo: <span class="hljs-string">'Conclusão'</span>,
  transacao: {
    id: <span class="hljs-string">"628638"</span>,
    parcelas: <span class="hljs-number">6</span>,
    frete: {
      modalidade: <span class="hljs-string">"E-Sedex"</span>,
      valor <span class="hljs-number">12.0</span>,
      dias: <span class="hljs-number">14</span>
    }
  }
});</code></pre>



<h3 id="coleta-de-banners"><strong>Coleta de Banners</strong></h3>

<p>Iremos coletar as impressões e cliques nos banners promocionais exibidos no site, para isso precisamos que seja implementado um push no dataLayer contendo algumas informações.</p>



<h4 id="impressões"><strong>Impressões</strong></h4>

<p>No caso das impressões, a página contendo banners, deve dar push no dataLayer no carregamento da página, pois estes dados serão enviados juntamente com o pageview.</p>

<p>As impressões precisam do seguintes dados:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>id</td>
  <td>String</td>
  <td>Identificador do banner</td>
  <td>passagens_321</td>
</tr>
<tr>
  <td>nome</td>
  <td>String</td>
  <td>Título ou nome do banner</td>
  <td>Passagens Nacionais</td>
</tr>
<tr>
  <td>criativo</td>
  <td>String</td>
  <td>Imagem do banner</td>
  <td>banner_passagens_nacionais_321</td>
</tr>
<tr>
  <td>posicao</td>
  <td>String</td>
  <td>Posição do banner</td>
  <td>banner_rodape_pos1</td>
</tr>
</tbody></table>


<p>Estes dados devem ser enviados para a camada no seguinte formato:</p>



<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
 <span class="hljs-string">'event'</span>: <span class="hljs-string">'navegacao'</span>,
 <span class="hljs-string">'banners'</span>: [{
    <span class="hljs-string">'id'</span>: <span class="hljs-string">'smartphones_99'</span>,
    <span class="hljs-string">'nome'</span>: <span class="hljs-string">'Smartphones com 10% de desconto'</span>,
    <span class="hljs-string">'criativo'</span>: <span class="hljs-string">'iphone_promo_discount'</span>,
    <span class="hljs-string">'posicao'</span>: <span class="hljs-string">'discount_list_1'</span>
  },{
    <span class="hljs-string">'id'</span>: <span class="hljs-string">' passagens_321'</span>,
    <span class="hljs-string">'nome'</span>: <span class="hljs-string">'Passagens Nacionais'</span>,
    <span class="hljs-string">'criativo'</span>: <span class="hljs-string">'banner_passagens_nacionais_321'</span>,
    <span class="hljs-string">'posicao'</span>: <span class="hljs-string">'banner_rodape_pos1'</span>
  }]
});</code></pre>

<h4 id="cliques"><strong>Cliques</strong></h4>

<p>Quando o usuário clicar em algum banner, a página deve dar push no dataLayer com os dados do banner clicado e uma chave “event” com o valor “clique_banner” pois estes dados serão enviados juntamente com o evento do clique.</p>

<p>Os cliques precisam do seguintes dados:</p>

<table>
<thead>
<tr>
  <th>Chave</th>
  <th>Tipo</th>
  <th>Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>id</td>
  <td>String</td>
  <td>Identificador do banner</td>
  <td>passagens_321</td>
</tr>
<tr>
  <td>nome</td>
  <td>String</td>
  <td>Título ou nome do banner</td>
  <td>String</td>
</tr>
<tr>
  <td>criativo</td>
  <td>String</td>
  <td>Imagem do banner</td>
  <td>banner_passagens_nacionais_321</td>
</tr>
<tr>
  <td>posicao</td>
  <td>String</td>
  <td>Posição do banner</td>
  <td>banner_rodape_pos1</td>
</tr>
</tbody></table>


<p>Estes dados devem ser enviados para a camada no seguinte formato:</p>

<pre class="prettyprint"><code class="language-js hljs ">dataLayer.push({
  <span class="hljs-string">'event'</span>: <span class="hljs-string">'clique_banner'</span>,
  <span class="hljs-string">'clique_banner'</span>: {
    <span class="hljs-string">'id'</span>: <span class="hljs-string">'passagens_321'</span>,
    <span class="hljs-string">'nome'</span>: <span class="hljs-string">'Passagens Nacionais'</span>,
    <span class="hljs-string">'criativo'</span>: <span class="hljs-string">'banner_passagens_nacionais_321'</span>,
    <span class="hljs-string">'posicao'</span>: <span class="hljs-string">'banner_rodape_pos1'</span>
  }
});</code></pre>



<h3 id="coleta-de-transações"><strong>Coleta de Transações</strong></h3>

<p>Para realizarmos a mensuração dos valores recebidos pelo Buscapé a cada lead (CPC, CPA ou Buscapé Checkouts), utilizaremos o Measurement Protocol através de uma implementação do lado do servidor da Buscapé. Isto permitirá que a coleta seja realizada sem abrir estes números para os usuários do site.</p>

<h4 id="fluxo"><strong>Fluxo</strong></h4>

<p>Conforme explicado no início deste documento, o envio de informações via servidor acontece em momentos diferentes, dependendo do tipo de lead:</p>

<p><strong>CPC</strong> - O envio ocorre logo após o clique no botão, durante o redirect para a página do parceiro [segue tabela 1].</p>

<p><strong>CPA</strong> - O envio acontece em 2 momentos diferentes:</p>

<ul>
<li>Primeiro logo após o clique no botão de redirect, assim como acontece com o caso do CPC [segue tabela 2] .</li>
<li>O segundo acontece após o usuário efetuar uma compra no site parceiro, e deve possuir os dados do produto e transação do clique (não da compra no parceiro), este segundo disparo pode acontecer mais de uma vez caso o usuário faça mais compras dentro do período de atribuição acordado com o cliente [segue tabela 1].</li>
</ul>

<p><strong>Checkout</strong> - O envio acontece após a aprovação da compra [segue tabela 1].</p>

<h4 id="implementação"><strong>Implementação</strong></h4>

<p>O Measurement Protocol é uma API para envio de informações para o Google Analytics que permite que hits sejam enviados mesmo fora do contexto do site, como por exemplo um evento disparado diretamente pelo backend.</p>

<p>O método de disparo é uma requisição HTTP, que pode ser feita via GET ou POST para o endpoint <a href="https://www.google-analytics.com/collect">https://www.google-analytics.com/collect</a>. O endpoint retorna um pixel GIF transparente, não há uma mensagem de retorno de sucesso ou erro.</p>

<p>Para testar a implementação recomendamos enviar o payload para <a href="https://www.google-analytics.com/debug/collect">https://www.google-analytics.com/debug/collect</a>, que retornará um JSON com os problemas encontrados. Também é possível apontar o parâmetro <strong>tid</strong> para uma propriedade vazia do Google Analytics e observar os dados na ferramenta, após um período de espera.</p>

<p>Exemplo:</p>



<pre class="prettyprint"><code class=" hljs bash"> &lt;?php
  <span class="hljs-variable">$endpoint</span> = <span class="hljs-string">"https://www.google-analytics.com/collect"</span>
  <span class="hljs-variable">$cid</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"cid"</span>];
  <span class="hljs-variable">$dr</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"referrer"</span>];
  <span class="hljs-variable">$dl</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"HTTP_REFERER"</span>];
  <span class="hljs-variable">$uip</span> = <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">"REMOTE_ADDR"</span>];
  <span class="hljs-variable">$random</span> = rand();
  <span class="hljs-variable">$ea</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"tipo_pagina"</span>];
  <span class="hljs-variable">$el</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">"nome_lista"</span>];
  ```
  // ... demais valores a serem preenchidos podem estar na própria requisição, mas alguns talvez tenham que vir de outras fontes

  <span class="hljs-variable">$url</span> = <span class="hljs-string">"<span class="hljs-variable">$endpoint</span>?v=1&amp;tid=UA-1827174-80&amp;cid=<span class="hljs-variable">$cid</span>&amp;uid=<span class="hljs-variable">$userID</span>&amp;ua=<span class="hljs-variable">$ua</span>&amp;dr=<span class="hljs-variable">$dr</span>&amp;dl=<span class="hljs-variable">$dl</span>&amp;uip=<span class="hljs-variable">$uip</span>&amp;ec=Conversao&amp;ea=CPC&amp;el=Clique&amp;z=<span class="hljs-variable">$random</span>"</span>;

  <span class="hljs-variable">$response</span> = file_get_contents(<span class="hljs-variable">$url</span>);
?&gt;</code></pre>

<p>Os parâmetros a seguir devem ser todos preenchidos para transações que ocorrerem devido a um clique no botão Ir a Loja (no caso de negociação CPC), ou quando houver a confirmação de compra (no caso de negociação CPA ou Buscapé Checkout). Deve-se garantir que todas as informações necessárias estarão disponíveis no momento da transação.</p>

<h4 id="tabela-1"><strong>tabela 1</strong></h4>

<table>
<thead>
<tr>
  <th>Parâmetro</th>
  <th align="left">Nome</th>
  <th align="left">Obrigatório</th>
  <th align="left">Descrição</th>
  <th>Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>v</td>
  <td align="left">Versão</td>
  <td align="left">Sim</td>
  <td align="left">Versão do protocolo, sempre igual à 1</td>
  <td>v=1</td>
</tr>
<tr>
  <td>cid</td>
  <td align="left">Id do Cliente</td>
  <td align="left">Sim</td>
  <td align="left">ClientID (CID), obtido a partir dos dois últimos juntos de número do cookie _ga. Caso o cookie não esteja definido, deve ser criado e salvo um valor no formado UUID v4</td>
  <td>cid=597491310.1483470579</td>
</tr>
<tr>
  <td>tid</td>
  <td align="left">Id de Acompanhamento</td>
  <td align="left">Sim</td>
  <td align="left">UA da propriedade do Analytics</td>
  <td>tid=UA-1827174-80</td>
</tr>
<tr>
  <td>uid</td>
  <td align="left">Id do Usuário</td>
  <td align="left">Não</td>
  <td align="left">Identificador do usuário logado</td>
  <td>uid=123234345</td>
</tr>
<tr>
  <td>ua</td>
  <td align="left">User Agent</td>
  <td align="left">Não</td>
  <td align="left">Identificador do navegador do usuário, obtido pelos headers da requisição ao servidor</td>
  <td>ua=Opera%2F9.80%20%28Windows%20NT%206.0%29%20Presto%2F2.12.388%20Version%2F12.14</td>
</tr>
<tr>
  <td>uip</td>
  <td align="left">Endereço de IP</td>
  <td align="left">Sim</td>
  <td align="left">Endereço de IP do usuário. Atenção! Não confundir com o endereço de IP do servidor</td>
  <td>uip=178.123.1.22</td>
</tr>
<tr>
  <td>t</td>
  <td align="left">Tipo de disparo</td>
  <td align="left">Sim</td>
  <td align="left">Para este caso, será sempre “event”</td>
  <td>t=event</td>
</tr>
<tr>
  <td>dl</td>
  <td align="left">Localizador do Documento</td>
  <td align="left">Não</td>
  <td align="left">URL da página atual</td>
  <td>dl=http%3A%2F%2Fwww.buscape.com.br%2Fredirect_prod</td>
</tr>
<tr>
  <td>dr</td>
  <td align="left">Referenciador do Documento</td>
  <td align="left">Não</td>
  <td align="left">URL da página anterior</td>
  <td>dr=https%3A%2F%2Fwww.buscape.com.br</td>
</tr>
<tr>
  <td>ec</td>
  <td align="left">Categoria do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td>ec=Conversao</td>
</tr>
<tr>
  <td>ea</td>
  <td align="left">Ação do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td>ea=CPC</td>
</tr>
<tr>
  <td>el</td>
  <td align="left">Rótulo do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td>el=Clique</td>
</tr>
<tr>
  <td>pa</td>
  <td align="left">Ação do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Sempre igual a purchase para este evento</td>
  <td>pa=purchase</td>
</tr>
<tr>
  <td>pr1br</td>
  <td align="left">Marca do Produto</td>
  <td align="left">Não</td>
  <td align="left">Marca do produto</td>
  <td>clicado  pr1br=Caloi</td>
</tr>
<tr>
  <td>pr1ca</td>
  <td align="left">Categoria do Produto</td>
  <td align="left">Não</td>
  <td align="left">Categoria e subcategorias do produto concatenadas com /, utilizar no máximo 5 níveis. Caso alguma categoria possua / em seu nome, remover antes de concatenar neste campo.</td>
  <td>pr1ca=Esporte%20e%20Lazer%2FCiclismo%2FBicicleta</td>
</tr>
<tr>
  <td>pr1cd2</td>
  <td align="left">Dimensão Personalizada 2</td>
  <td align="left">Não</td>
  <td align="left">Nome do lojista</td>
  <td>pr1cd2=Submarino</td>
</tr>
<tr>
  <td>pr1cd5</td>
  <td align="left">Dimensão Personalizada 5</td>
  <td align="left">Sim</td>
  <td align="left">Indicação se o método acordado de faturamento é CPC, CPA ou Checkout</td>
  <td>pr1cd5=CPC</td>
</tr>
<tr>
  <td>pr1cm6</td>
  <td align="left">Métrica Personalizada 6</td>
  <td align="left">Sim</td>
  <td align="left">Valor de exibição para o preço da oferta</td>
  <td>pr1cm6=509.99</td>
</tr>
<tr>
  <td>pr1id</td>
  <td align="left">SKU do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Id da oferta clicada</td>
  <td>pr1id=628638</td>
</tr>
<tr>
  <td>pr1nm</td>
  <td align="left">Nome do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Nome do produto clicado</td>
  <td>pr1nm=Caloi Star Wars Aro 24</td>
</tr>
<tr>
  <td>pr1pr</td>
  <td align="left">Preço do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Valor do CPC ou CPA acordado para esta oferta</td>
  <td>pr1pr=0.50</td>
</tr>
<tr>
  <td>pr1ps</td>
  <td align="left">Posição do Produto</td>
  <td align="left">Não</td>
  <td align="left">Posição da oferta na lista onde foi clicada</td>
  <td>pr1ps=2</td>
</tr>
<tr>
  <td>pr1qt</td>
  <td align="left">Quantidade do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Quantidade, para CPC e CPA será sempre igual a 1</td>
  <td>pr1qt=1</td>
</tr>
<tr>
  <td>ti</td>
  <td align="left">ID da Transação</td>
  <td align="left">Sim</td>
  <td align="left">Código único que representa a transação deste produto</td>
  <td>ti=14l33478</td>
</tr>
<tr>
  <td>tr</td>
  <td align="left">Receita</td>
  <td align="left">Sim</td>
  <td align="left">Valor total da transação, deve ser igual ao Preço do Produto vezes a Quantidade</td>
  <td>tr=0.50</td>
</tr>
<tr>
  <td>cm1</td>
  <td align="left">Métrica Personalizada 1</td>
  <td align="left">Sim</td>
  <td align="left">Contador de cliques em ofertas com negociação CPC, deve ser 1 quando CPC, 0 caso CPA ou Checkout</td>
  <td>cm1=1</td>
</tr>
<tr>
  <td>cm2</td>
  <td align="left">Métrica Personalizada 2</td>
  <td align="left">Sim</td>
  <td align="left">Contador de transações em ofertas com negociação CPA, deve ser 1 quando CPA, 0 caso CPC ou Checkout</td>
  <td>cm2=0</td>
</tr>
<tr>
  <td>z</td>
  <td align="left">Cache Buster</td>
  <td align="left">Sim</td>
  <td align="left">Deve conter uma sequência aleatória de números e estar sempre ao final da URL enviada</td>
  <td>z=79214683215</td>
</tr>
</tbody></table>


<p>No caso do Checkout, onde podem haver mais de um produto na transação, os valores relativos aos produtos (pr1ca, pr1cd2, pr1cm6, pr1nm, pr1id, pr1pr, pr1ps e pr1qt) devem ser repetidos variando o prefixo pr1 (pr2, pr3, pr4, etc) para cada um dos produtos.</p>

<p><strong>tabela 2 (somente para o primeiro evento do CPA)</strong></p>

<table>
<thead>
<tr>
  <th>Parâmetro</th>
  <th align="left">Nome</th>
  <th align="left">Obrigatório</th>
  <th align="left">Descrição</th>
  <th align="left">Exemplo</th>
</tr>
</thead>
<tbody><tr>
  <td>v</td>
  <td align="left">Versão</td>
  <td align="left">Sim</td>
  <td align="left">Versão do protocolo, sempre igual à 1</td>
  <td align="left">v=1</td>
</tr>
<tr>
  <td>cid</td>
  <td align="left">Id do Cliente</td>
  <td align="left">Sim</td>
  <td align="left">ClientID (CID), obtido a partir dos dois últimos juntos de número do cookie _ga. Caso o cookie não esteja definido, deve ser criado e salvo um valor no formado UUID v4</td>
  <td align="left">cid=597491310.1483470579</td>
</tr>
<tr>
  <td>tid</td>
  <td align="left">Id de Acompanhamento</td>
  <td align="left">Sim</td>
  <td align="left">UA da propriedade do Analytics</td>
  <td align="left">tid=UA-1827174-80</td>
</tr>
<tr>
  <td>uid</td>
  <td align="left">Id do Usuário</td>
  <td align="left">Não</td>
  <td align="left">Identificador do usuário logado</td>
  <td align="left">uid=123234345</td>
</tr>
<tr>
  <td>ua</td>
  <td align="left">User Agent</td>
  <td align="left">Não</td>
  <td align="left">Identificador do navegador do usuário, obtido pelos headers da requisição ao servidor</td>
  <td align="left">ua=Opera%2F9.80%20%28Windows%20NT%206.0%29%20Presto%2F2.12.388%20Version%2F12.14</td>
</tr>
<tr>
  <td>uip</td>
  <td align="left">Endereço de IP</td>
  <td align="left">Sim</td>
  <td align="left">Endereço de IP do usuário. Atenção! Não confundir com o endereço de IP do servidor</td>
  <td align="left">uip=178.123.1.22</td>
</tr>
<tr>
  <td>t</td>
  <td align="left">Tipo de disparo</td>
  <td align="left">Sim</td>
  <td align="left">Para este caso, será sempre “event”</td>
  <td align="left">t=event</td>
</tr>
<tr>
  <td>dl</td>
  <td align="left">Localizador do Documento</td>
  <td align="left">Não</td>
  <td align="left">URL da página atual</td>
  <td align="left">dl=http%3A%2F%2Fwww.buscape.com.br%2Fredirect_prod</td>
</tr>
<tr>
  <td>dr</td>
  <td align="left">Referenciador do Documento</td>
  <td align="left">Não</td>
  <td align="left">URL da página anterior</td>
  <td align="left">dr=https%3A%2F%2Fwww.buscape.com.br</td>
</tr>
<tr>
  <td>ec</td>
  <td align="left">Categoria do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td align="left">ec=Conversao</td>
</tr>
<tr>
  <td>ea</td>
  <td align="left">Ação do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td align="left">ea=CPA</td>
</tr>
<tr>
  <td>el</td>
  <td align="left">Rótulo do Evento</td>
  <td align="left">Sim</td>
  <td align="left">Ver a tabela de eventos</td>
  <td align="left">el=Clique</td>
</tr>
<tr>
  <td>pr1br</td>
  <td align="left">Marca do Produto</td>
  <td align="left">Não</td>
  <td align="left">Marca do produto clicado</td>
  <td align="left">pr1br=Caloi</td>
</tr>
<tr>
  <td>pr1ca</td>
  <td align="left">Categoria do Produto</td>
  <td align="left">Não</td>
  <td align="left">Categoria e subcategorias do produto concatenadas com /, utilizar no máximo 5 níveis. Caso alguma categoria possua / em seu nome, remover antes de concatenar neste campo.</td>
  <td align="left">pr1ca=Esporte%20e%20Lazer%2FCiclismo%2FBicicleta</td>
</tr>
<tr>
  <td>pr1cd2</td>
  <td align="left">Dimensão Personalizada 2</td>
  <td align="left">Não</td>
  <td align="left">Nome do lojista</td>
  <td align="left">pr1cd2=Submarino</td>
</tr>
<tr>
  <td>pr1cd5</td>
  <td align="left">Dimensão Personalizada 5</td>
  <td align="left">Sim</td>
  <td align="left">Indicação se o método acordado de faturamento é CPC, CPA ou Checkout</td>
  <td align="left">pr1cd5=CPA</td>
</tr>
<tr>
  <td>pr1cm6</td>
  <td align="left">Métrica Personalizada 6</td>
  <td align="left">Sim</td>
  <td align="left">Valor de exibição para o preço da oferta</td>
  <td align="left">pr1cm6=509.99</td>
</tr>
<tr>
  <td>pr1id</td>
  <td align="left">SKU do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Id da oferta clicada</td>
  <td align="left">pr1id=628638</td>
</tr>
<tr>
  <td>pr1nm</td>
  <td align="left">Nome do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Nome do produto clicado</td>
  <td align="left">pr1nm=Caloi Star Wars Aro 24</td>
</tr>
<tr>
  <td>pr1ps</td>
  <td align="left">Posição do Produto</td>
  <td align="left">Não</td>
  <td align="left">Posição da oferta na lista onde foi clicada</td>
  <td align="left">pr1ps=2</td>
</tr>
<tr>
  <td>pr1qt</td>
  <td align="left">Quantidade do Produto</td>
  <td align="left">Sim</td>
  <td align="left">Quantidade será sempre igual a 1</td>
  <td align="left">pr1qt=1</td>
</tr>
<tr>
  <td>cm1</td>
  <td align="left">Métrica Personalizada 1</td>
  <td align="left">Sim</td>
  <td align="left">Contador de cliques em ofertas com negociação CPC, deve ser 1 quando CPC, 0 caso CPA ou Checkout</td>
  <td align="left">cm1=0</td>
</tr>
<tr>
  <td>cm2</td>
  <td align="left">Métrica Personalizada 2</td>
  <td align="left">Sim</td>
  <td align="left">Contador de transações em ofertas com negociação CPA, deve ser 1 quando CPA, 0 caso CPC ou Checkout</td>
  <td align="left">cm2=1</td>
</tr>
<tr>
  <td>z</td>
  <td align="left">Cache Buster</td>
  <td align="left">Sim</td>
  <td align="left">Deve conter uma sequência aleatória de números e estar sempre ao final da URL enviada</td>
  <td align="left">z=79214683215</td>
</tr>
</tbody></table>


<p>Os parâmetros ec, ea e el acima, devem ser preenchidos segundo os valores da tabela de eventos:</p>

<h4 id="tabela-de-eventos"><strong>tabela de eventos</strong></h4>

<table>
<thead>
<tr>
  <th>Tipo de Lead</th>
  <th>Categoria (ec)</th>
  <th>Ação (ea)</th>
  <th>Rótulo (el)</th>
</tr>
</thead>
<tbody><tr>
  <td>CPC</td>
  <td>Conversao</td>
  <td>CPC</td>
  <td>Clique</td>
</tr>
<tr>
  <td>CPA (no redirect)</td>
  <td>Conversao</td>
  <td>CPA</td>
  <td>Clique</td>
</tr>
<tr>
  <td>CPA (após a compra)</td>
  <td>Conversao</td>
  <td>CPA</td>
  <td>Compra</td>
</tr>
<tr>
  <td>Checkout</td>
  <td>Conversao</td>
  <td>Checkout</td>
  <td>Compra</td>
</tr>
</tbody></table>




<h4 id="exemplo-de-envio"><strong>Exemplo de envio</strong></h4>

<p>Estes dados podem ser enviados tanto via GET quanto via POST. Devido ao tamanho da requisição, recomendamos que sempre seja enviado via POST. Utilizando os dados exemplo acima, deveria ser enviado o seguinte disparo:</p>



<pre class="prettyprint"><code class=" hljs http"><span class="hljs-request">POST <span class="hljs-string">/collect</span> HTTP/1.1</span>
<span class="hljs-attribute">Host</span>: <span class="hljs-string">www.google-analytics.com</span>

<span class="perl">v=<span class="hljs-number">1</span>&amp;cid=<span class="hljs-number">597491310.1483470579</span>&amp;tid=UA-<span class="hljs-number">1827174</span>-<span class="hljs-number">80</span>&amp;uid=<span class="hljs-number">123234345</span>&amp;ua=Opera<span class="hljs-variable">%2F9</span>.<span class="hljs-number">80</span><span class="hljs-variable">%20</span><span class="hljs-variable">%28Windows</span><span class="hljs-variable">%20NT</span><span class="hljs-variable">%206</span>.<span class="hljs-number">0</span><span class="hljs-variable">%29</span><span class="hljs-variable">%20Pres</span>&amp;o<span class="hljs-variable">%2F2</span>.<span class="hljs-number">12.388</span><span class="hljs-variable">%20Version</span><span class="hljs-variable">%2F12</span>.<span class="hljs-number">14</span>&amp;uip=<span class="hljs-number">178.123</span>.<span class="hljs-number">1.22</span>&amp;t=event&amp;dl=http<span class="hljs-variable">%3A</span><span class="hljs-variable">%2F</span><span class="hljs-variable">%2Fwww</span>.buscape.com.br<span class="hljs-variable">%2Fredirect_prod</span>&amp;dr=https<span class="hljs-variable">%3A</span><span class="hljs-variable">%2F</span><span class="hljs-variable">%2Fwww</span>.buscape.com.br&amp;ec=Conversao&amp;ea=CPC&amp;el=Clique&amp;pa=purchase&amp;pr1br=Caloi&amp;pr1ca=Esporte<span class="hljs-variable">%20e</span><span class="hljs-variable">%20Lazer</span><span class="hljs-variable">%2FCiclismo</span><span class="hljs-variable">%2FBicicleta</span>&amp;pr1cd2=Submarino&amp;pr1cd5=CPC&amp;pr1cm6=<span class="hljs-number">509.99</span>&amp;pr1id=<span class="hljs-number">628638</span>&amp;pr1nm=Caloi<span class="hljs-variable">%20Star</span><span class="hljs-variable">%20Wars</span><span class="hljs-variable">%20Aro</span><span class="hljs-variable">%2024</span>&amp;pr1pr=<span class="hljs-number">0</span>.<span class="hljs-number">50</span>&amp;pr1ps=<span class="hljs-number">2</span>&amp;pr1qt=<span class="hljs-number">1</span>&amp;ti=<span class="hljs-number">14</span>l33478&amp;<span class="hljs-keyword">tr</span>=<span class="hljs-number">0</span>.<span class="hljs-number">50</span>&amp;cm1=<span class="hljs-number">1</span>&amp;cm2=<span class="hljs-number">0</span>&amp;z=<span class="hljs-number">79214683215</span>
</span></code></pre>